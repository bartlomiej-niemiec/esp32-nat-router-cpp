// SPDX-FileCopyrightText: 2024 Cesanta Software Limited
// SPDX-License-Identifier: GPL-2.0-only or commercial
// Generated by Mongoose Wizard, https://mongoose.ws/wizard/

#ifndef MONGOOSE_GLUE_H
#define MONGOOSE_GLUE_H

#ifdef __cplusplus
extern "C" {
#endif

#include "mongoose.h"

#define WIZARD_ENABLE_HTTP 1
#define WIZARD_ENABLE_HTTPS 1
#define WIZARD_ENABLE_HTTP_UI 1
#define WIZARD_ENABLE_HTTP_UI_LOGIN 1

#define WIZARD_ENABLE_WEBSOCKET 0

#define WIZARD_ENABLE_MQTT 0
#define WIZARD_ENABLE_OTA_OVER_MQTT 0
#define WIZARD_MQTT_DEVICE_ID ""
#define WIZARD_MQTT_URL ""

#define WIZARD_ENABLE_SNTP 0  // Enable time sync.
#define WIZARD_SNTP_TYPE 0    // 0: default Google, 1: DHCP, 2: custom
#define WIZARD_SNTP_URL "udp://time.google.com:123"  // Custom SNTP server URL
#define WIZARD_SNTP_INTERVAL_SECONDS 3600            // Frequency of SNTP syncs

#define WIZARD_DNS_TYPE 0  // 0: default Google, 1: DHCP, 2: custom
#define WIZARD_DNS_URL "udp://8.8.8.8:53"  // Custom DNS server URL
#define WIZARD_CAPTIVE_PORTAL 0
#define WIZARD_ENABLE_MDNS 0
#define WIZARD_MDNS_NAME ""

#define WIZARD_ENABLE_WIFI 0
#ifndef WIZARD_WIFI_NAME  // Allow to set WIZARD_WIFI_NAME from build params
#define WIZARD_WIFI_NAME "MyNet"
#endif
#ifndef WIZARD_WIFI_PASS  // Allow to set WIZARD_WIFI_PASS from build params
#define WIZARD_WIFI_PASS "MyPass"
#endif
#define WIZARD_ENABLE_WIFI_AP 0
#define WIZARD_WIFI_AP_NAME "MyAp"
#define WIZARD_WIFI_AP_PASS "MyApPass"

#define WIZARD_ENABLE_MODBUS 0
#define WIZARD_MODBUS_PORT 502

#ifndef WIZARD_REBOOT_TIMEOUT_MS
#define WIZARD_REBOOT_TIMEOUT_MS 500
#endif

void mongoose_init(void);    // Initialise Mongoose
void mongoose_poll(void);    // Poll Mongoose
extern struct mg_mgr g_mgr;  // Mongoose event manager

void mongoose_set_http_handlers(const char *name, ...);
void mongoose_add_ws_handler(unsigned ms, void (*)(struct mg_connection *));
void mongoose_add_ws_reporter(unsigned ms, const char *name);

struct mongoose_mqtt_handlers {
  struct mg_connection *(*connect_fn)(mg_event_handler_t);
  void (*on_connect_fn)(struct mg_connection *, int);
  void (*on_message_fn)(struct mg_connection *, struct mg_str, struct mg_str);
  void (*on_cmd_fn)(struct mg_connection *, struct mg_mqtt_message *);
};
void mongoose_set_mqtt_handlers(struct mongoose_mqtt_handlers *);

struct mongoose_modbus_handlers {
  bool (*read_reg_fn)(uint16_t address, uint16_t *value);
  bool (*write_reg_fn)(uint16_t address, uint16_t value);
};
void mongoose_set_modbus_handlers(struct mongoose_modbus_handlers *);

void mongoose_set_sntp_handler(void (*fn)(uint64_t epoch_ms));
void mongoose_set_sntp_server(const char *url);

void mongoose_set_auth_handler(int (*fn)(const char *user, const char *pass));

void mongoose_add_custom_handler(const char *url_pattern, mg_event_handler_t,
                                 int read_level, int write_level);

struct mongoose_wifi_handlers {
  void (*on_connect_fn)(struct mg_tcpip_if *);
  void (*on_disconnect_fn)(struct mg_tcpip_if *);
  void (*on_connect_error_fn)(struct mg_tcpip_if *);
  void (*on_scan_result_fn)(struct mg_tcpip_if *, struct mg_wifi_scan_bss_data *);
  void (*on_scan_end_fn)(struct mg_tcpip_if *);
};
void mongoose_set_wifi_handlers(struct mongoose_wifi_handlers *);

#if WIZARD_ENABLE_MQTT
void glue_lock_init(void);  // Initialise global Mongoose mutex
void glue_lock(void);       // Lock global Mongoose mutex
void glue_unlock(void);     // Unlock global Mongoose mutex
#else
#define glue_lock_init()
#define glue_lock()
#define glue_unlock()
#endif

// Update MDNS name. Works when MDNS is enabled.
void glue_mdns_update_name(const char *newname);

// Increment device change state counter - trigger UI refresh
void glue_update_state(void);

// Firmware Glue


int    glue_authenticate(const char *user, const char *pass);

void glue_start_applynetworkconfig(struct mg_str);  // Start an action
bool glue_check_applynetworkconfig(void);  // Check if action is still in progress

struct login {
  char password[32];
  char username[32];
};
void glue_get_login(struct login *);
void glue_set_login(struct login *);

struct saveapsettings {
  char networkmask[16];
  char ipaddress[16];
  char password[64];
  char name[32];
};
void glue_get_saveapsettings(struct saveapsettings *);
void glue_set_saveapsettings(struct saveapsettings *);

struct savestasettings {
  char Name[32];
  char Password[64];
  int SSIDNoId;
};
void glue_get_savestasettings(struct savestasettings *);
void glue_set_savestasettings(struct savestasettings *);

struct stanetworks {
  char net8_auth[32];
  int net8_channel;
  int net8_rssi;
  char net8_ssid[32];
  char net7_auth[32];
  int net7_channel;
  int net7_rssi;
  char net7_ssid[32];
  char net6_auth[32];
  int net6_channel;
  int net6_rssi;
  char net6_ssid[32];
  int networkFound;
  char net1_ssid[32];
  int net1_rssi;
  int net1_channel;
  char net1_auth[32];
  char net2_ssid[32];
  int net2_rssi;
  int net2_channel;
  char net2_auth[32];
  char net3_ssid[32];
  int net3_rssi;
  int net3_channel;
  char net3_auth[32];
  char net4_ssid[32];
  int net4_rssi;
  int net4_channel;
  char net4_auth[32];
  char net5_ssid[32];
  int net5_rssi;
  int net5_channel;
  char net5_auth[32];
};
void glue_get_stanetworks(struct stanetworks *);

void glue_start_setsta(struct mg_str);  // Start an action
bool glue_check_setsta(void);  // Check if action is still in progress

struct info {
  int Clients;
  bool StaIa;
  bool StaConn;
  char State[32];
  char STA[32];
  char AP[32];
};
void glue_get_info(struct info *);
void glue_set_info(struct info *);

void glue_start_scannetworks(struct mg_str);  // Start an action
bool glue_check_scannetworks(void);  // Check if action is still in progress


void glue_start_save_event(struct mg_str);  // Start an action
bool glue_check_save_event(void);  // Check if action is still in progress

struct proto_stats_ip {
  int lenerr;
  int chkerr;
  int drop;
  int fw;
  int rx;
  int tx;
};
void glue_get_proto_stats_ip(struct proto_stats_ip *);
void glue_set_proto_stats_ip(struct proto_stats_ip *);

struct proto_stats_tcp {
  int lenerr;
  int chkerr;
  int drop;
  int fw;
  int rx;
  int tx;
};
void glue_get_proto_stats_tcp(struct proto_stats_tcp *);
void glue_set_proto_stats_tcp(struct proto_stats_tcp *);

struct proto_stats_udp {
  int lenerr;
  int chkerr;
  int drop;
  int fw;
  int rx;
  int tx;
};
void glue_get_proto_stats_udp(struct proto_stats_udp *);
void glue_set_proto_stats_udp(struct proto_stats_udp *);

struct proto_stats_icmp {
  int chkerr;
  int lenerr;
  int drop;
  int fw;
  int rx;
  int tx;
};
void glue_get_proto_stats_icmp(struct proto_stats_icmp *);
void glue_set_proto_stats_icmp(struct proto_stats_icmp *);

struct napt_stats {
  int forced_evictions_no;
  int active_icmp_conn;
  int active_udp_conn;
  int active_tcp_conn;
};
void glue_get_napt_stats(struct napt_stats *);
void glue_set_napt_stats(struct napt_stats *);

void glue_reply_events(struct mg_connection *, struct mg_http_message *);

#ifdef __cplusplus
}
#endif
#endif  // MONGOOSE_GLUE_H
